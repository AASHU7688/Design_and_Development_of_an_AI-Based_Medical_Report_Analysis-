{% extends 'base.html' %}
{% block title %}Chatbot - MediScan{% endblock %}

{% block extra_css %}
<style>
	.chat-wrapper {
		max-width: 900px;
		margin: 0 auto;
		padding: 2rem;
	}
	.chat-card {
		background: rgba(255,255,255,0.95);
		backdrop-filter: blur(10px);
		border-radius: 16px;
		box-shadow: 0 10px 30px rgba(0,0,0,0.1);
		overflow: hidden;
		display: flex;
		flex-direction: column;
		height: 70vh;
	}
	.chat-header {
		padding: 1rem 1.5rem;
		border-bottom: 1px solid rgba(0,0,0,0.05);
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}
	.chat-header .title {
		font-weight: 600;
		color: #333;
	}
	.chat-messages {
		flex: 1;
		padding: 1rem 1.5rem;
		overflow-y: auto;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}
	.message {
		max-width: 80%;
		padding: 0.75rem 1rem;
		border-radius: 12px;
		line-height: 1.5;
		box-shadow: 0 4px 12px rgba(0,0,0,0.06);
	}
	.message.user { align-self: flex-end; background: #667eea; color: #fff; }
	.message.bot { align-self: flex-start; background: #f5f7ff; color: #333; }
	.message .content p { margin: 0.4rem 0; }
	.message .content ul { margin: 0.5rem 0 0.5rem 1.25rem; }
	.message .content code, .message .content pre { background: #eef0ff; padding: 0.1rem 0.3rem; border-radius: 6px; }
	.chat-input {
		display: flex;
		gap: 0.75rem;
		padding: 1rem 1.5rem;
		border-top: 1px solid rgba(0,0,0,0.05);
	}
	.chat-input input {
		flex: 1;
		padding: 0.75rem 1rem;
		border-radius: 10px;
		border: 1px solid #e3e6ff;
		outline: none;
		font-family: inherit;
	}
	.chat-input button {
		padding: 0.75rem 1.25rem;
		border-radius: 10px;
		border: none;
		background: linear-gradient(135deg, #667eea, #764ba2);
		color: #fff;
		cursor: pointer;
	}
	.helper {
		font-size: 0.9rem;
		color: #555;
		margin-top: 0.75rem;
		text-align: center;
	}
</style>
{% endblock %}

{% block content %}
<div class="container chat-wrapper">
	<div class="chat-card">
		<div class="chat-header">
			<i class="fas fa-robot" style="color:#764ba2"></i>
			<div class="title">Medical Assistant Chatbot</div>
		</div>
		<div id="messages" class="chat-messages">
			<div class="message bot"><div class="content">Hi! Ask me about your report findings or general medical questions. I provide informational guidance only.</div></div>
			{% if chat_history %}
				{% for item in chat_history %}
					<div class="message {% if item.role == 'user' %}user{% else %}bot{% endif %}"><div class="content">{{ item.content }}</div></div>
				{% endfor %}
			{% endif %}
		</div>
		<form id="chat-form" class="chat-input">
			<input id="chat-input" type="text" placeholder="Type your question..." autocomplete="off" required />
			<button type="submit"><i class="fas fa-paper-plane"></i></button>
		</form>

	</div>
	<div class="helper">Disclaimer: This chatbot provides general information and is not a substitute for professional medical advice.</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
	const form = document.getElementById('chat-form');
	const input = document.getElementById('chat-input');
	const messages = document.getElementById('messages');

	function appendMessage(text, role) {
		const div = document.createElement('div');
		div.className = `message ${role}`;
		const content = document.createElement('div');
		content.className = 'content';
		// Render markdown safely if available
		if (window.DOMPurify && window.marked) {
			content.innerHTML = DOMPurify.sanitize(marked.parse(text));
		} else {
			content.textContent = text;
		}
		div.appendChild(content);
		messages.appendChild(div);
		messages.scrollTop = messages.scrollHeight;
	}

	form.addEventListener('submit', async (e) => {
		e.preventDefault();
		const text = input.value.trim();
		if (!text) return;
		appendMessage(text, 'user');
		input.value = '';

		const formData = new FormData();
		formData.append('message', text);

		try {
			const resp = await fetch('{% url "chatbot" %}', {
				method: 'POST',
				headers: { 'X-CSRFToken': getCookie('csrftoken') },
				body: formData
			});
			const data = await resp.json();
			if (data.reply) {
				appendMessage(data.reply, 'bot');
			} else {
				appendMessage(data.error || 'Something went wrong.', 'bot');
			}
		} catch (err) {
			appendMessage('Network error. Please try again.', 'bot');
		}
	});



	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}
</script>
<!-- Safe Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}


